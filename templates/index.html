<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Code Morpher</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Prism.js for syntax highlighting -->
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>

  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6366f1; }

    pre {
      position: relative;
      background: #1e1e2e;
      color: #cbd5e1;
      border-radius: 0.75rem;
      padding: 1rem;
      overflow-x: auto;
      font-size: 0.95rem;
      width: 100%;
    }

    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #374151;
      color: white;
      font-size: 0.8rem;
      padding: 0.3rem 0.6rem;
      border-radius: 0.4rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    pre:hover .copy-btn {
      opacity: 1;
    }
  </style>
</head>

<body class="bg-gray-950 text-white min-h-screen flex flex-col font-sans">

  <!-- Navbar -->
  <nav class="w-full bg-gray-900 py-4 px-10 flex items-center justify-between shadow-md fixed top-0 left-0 z-10">
    <h1 class="text-2xl font-bold text-indigo-400">Code Morpher</h1>
  </nav>

  <!-- Chat Container -->
  <div id="chatContainer" class="flex-1 w-full max-w-5xl mx-auto mt-24 px-4 pb-28 overflow-y-auto space-y-6">
    <!-- Messages dynamically inserted here -->
  </div>

  <!-- Input Box -->
  <div class="fixed bottom-0 left-0 w-full bg-gray-900 py-4 px-6 flex items-center justify-center shadow-lg">
    <div class="flex items-center bg-gray-800 rounded-full px-6 py-3 w-full max-w-3xl">
      <input
        id="dslInput"
        type="text"
        placeholder="Ask something..."
        class="flex-grow bg-transparent text-gray-300 placeholder-gray-500 focus:outline-none text-lg"
        oninput="toggleButton()"
        onkeydown="if(event.key === 'Enter') generateJava()"
      />
      <button id="sendBtn" onclick="generateJava()" disabled
        class="ml-3 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-700 rounded-full p-3 transition">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
          stroke-width="2" stroke="white" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M5 12h14M12 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <script>
    function toggleButton() {
      const input = document.getElementById('dslInput').value.trim();
      document.getElementById('sendBtn').disabled = input === "";
    }

    async function generateJava() {
      const input = document.getElementById('dslInput').value.trim();
      if (!input) return;

      const chatContainer = document.getElementById('chatContainer');
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;

      // User message
      const userMsg = document.createElement('div');
      userMsg.className = "text-right";
      userMsg.innerHTML = `
        <div class="inline-block bg-indigo-600 text-white px-4 py-2 rounded-2xl max-w-2xl break-words shadow-md">
          ${input}
        </div>`;
      chatContainer.appendChild(userMsg);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      document.getElementById('dslInput').value = "";

      // Bot placeholder
      const botMsg = document.createElement('div');
      botMsg.className = "text-left w-full";
      botMsg.innerHTML = `
        <div class="inline-block bg-gray-800 text-gray-300 px-4 py-3 rounded-2xl shadow-md">
          Processing... ⏳
        </div>`;
      chatContainer.appendChild(botMsg);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      try {
        const res = await fetch("https://code-morpher-a.onrender.com/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ dsl_input: input })
        });

        const data = await res.json();
        const resultText = data.java_code || "❌ " + (data.error || "Unknown error");

        botMsg.innerHTML = `
          <pre class="language-java rounded-xl">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <code class="language-java">${Prism.highlight(resultText, Prism.languages.java, 'java')}</code>
          </pre>
        `;

        if (data.cached) {
          botMsg.innerHTML += `<div class="text-xs text-gray-500 mt-1">⚡ (Loaded from cache)</div>`;
        }

      } catch (err) {
        botMsg.innerHTML = `
          <div class="inline-block bg-red-700 text-white px-4 py-3 rounded-2xl max-w-2xl break-words shadow-md">
            ❌ Failed to connect to backend.<br>${err}
          </div>`;
      }

      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function copyCode(button) {
      const code = button.nextElementSibling.innerText;
      navigator.clipboard.writeText(code);
      button.textContent = "Copied!";
      setTimeout(() => (button.textContent = "Copy"), 2000);
    }
  </script>
</body>
</html>
