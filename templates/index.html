<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Code Morpher</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-950 text-white min-h-screen flex">
  <!-- Sidebar -->
  <div id="sidebar" class="w-64 bg-gray-900 flex flex-col p-4 border-r border-gray-800">
    <h2 class="text-xl font-semibold text-indigo-400 mb-4 text-center">Code Morpher</h2>
    <button id="newChatBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-2 rounded-md mb-4 transition">
      + New Chat
    </button>
    <div id="history" class="flex-1 overflow-y-auto space-y-2">
      <!-- History items appear here -->
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col items-center justify-center p-4 sm:p-8">
    <nav class="w-full bg-gray-900 py-4 px-6 flex items-center justify-between shadow-md fixed top-0 left-0 z-10">
      <h1 class="text-xl sm:text-2xl font-bold text-indigo-400">Code Morpher</h1>
    </nav>

    <div class="w-full max-w-4xl bg-gray-900 shadow-2xl rounded-2xl p-6 sm:p-10 mt-24 flex flex-col space-y-6">
      <h2 class="text-2xl sm:text-3xl font-semibold text-center text-indigo-400 mb-4">
        Hello, how can I help you?
      </h2>

      <!-- Chat Container -->
      <div id="chatContainer"
        class="flex-1 overflow-y-auto space-y-4 max-h-[60vh] p-4 bg-gray-800 rounded-xl border border-gray-700">
      </div>

      <!-- Input Box -->
      <div class="flex items-center bg-gray-800 rounded-full px-4 sm:px-6 py-3">
        <input id="dslInput" type="text" placeholder="Enter your prompt..."
          class="flex-grow bg-transparent text-gray-300 placeholder-gray-500 focus:outline-none text-base sm:text-lg" />
        <button id="sendBtn" onclick="generateJava()" disabled
          class="ml-3 bg-indigo-600 hover:bg-indigo-700 rounded-full p-3 transition disabled:opacity-50">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white"
            class="w-5 h-5 sm:w-6 sm:h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    const chatContainer = document.getElementById("chatContainer");
    const input = document.getElementById("dslInput");
    const sendBtn = document.getElementById("sendBtn");
    const historyDiv = document.getElementById("history");
    const newChatBtn = document.getElementById("newChatBtn");

    // Enable button only when user types something
    input.addEventListener("input", () => {
      sendBtn.disabled = input.value.trim() === "";
    });

    // Load chat history
    window.onload = function () {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      history.forEach(item => renderHistoryItem(item.prompt, item.response));
      history.forEach(item => renderMessage(item.prompt, item.response));
    };

    async function generateJava() {
      const userInput = input.value.trim();
      if (!userInput) return;

      renderMessage(userInput, null);
      input.value = "";
      sendBtn.disabled = true;

      try {
        const res = await fetch("https://your-backend-url.onrender.com/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ dsl_input: userInput })
        });

        const data = await res.json();
        const response = data.java_code || data.error || "Error generating response.";

        renderMessage(userInput, response);
        saveToHistory(userInput, response);
        renderHistoryItem(userInput, response);

      } catch (err) {
        renderMessage(userInput, "âŒ Failed to connect to backend. Please try again.");
      }
    }

    // Render chat messages
    function renderMessage(prompt, response) {
      const chatBox = document.createElement("div");
      chatBox.className = "space-y-2";

      const userBubble = document.createElement("div");
      userBubble.className = "bg-indigo-600 text-white p-3 rounded-xl max-w-[90%] self-end ml-auto";
      userBubble.textContent = prompt;
      chatBox.appendChild(userBubble);

      if (response) {
        const botContainer = document.createElement("div");
        botContainer.className = "bg-gray-700 text-green-400 p-3 rounded-xl max-w-[90%] whitespace-pre-wrap relative";

        const copyBtn = document.createElement("button");
        copyBtn.textContent = "Copy";
        copyBtn.className = "absolute top-2 right-3 text-xs bg-indigo-600 hover:bg-indigo-700 px-2 py-1 rounded-md";
        copyBtn.onclick = () => copyCode(response, copyBtn);

        botContainer.appendChild(copyBtn);
        const codeBlock = document.createElement("pre");
        codeBlock.textContent = response;
        botContainer.appendChild(codeBlock);
        chatBox.appendChild(botContainer);
      }

      chatContainer.appendChild(chatBox);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function renderHistoryItem(prompt, response) {
      const btn = document.createElement("button");
      btn.className = "history-item w-full text-left bg-gray-800 hover:bg-gray-700 p-2 rounded-md text-sm text-gray-300";
      btn.textContent = prompt.slice(0, 25) + "...";
      btn.onclick = () => {
        chatContainer.innerHTML = "";
        renderMessage(prompt, response);
      };
      historyDiv.appendChild(btn);
    }

    function saveToHistory(prompt, response) {
      let history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      history.push({ prompt, response });
      localStorage.setItem("chatHistory", JSON.stringify(history));
    }

    function copyCode(code, btn) {
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = "Copied!";
        setTimeout(() => (btn.textContent = "Copy"), 2000);
      });
    }

    // New Chat button
    newChatBtn.addEventListener("click", () => {
      chatContainer.innerHTML = "";
      input.value = "";
    });

    // Press Enter to send
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        generateJava();
      }
    });
  </script>
</body>
</html>
